# Drouple Mobile Analytics Alert Rules
# Monitors PRD KPI regressions and performance degradations

groups:
  - name: mobile.adoption
    rules:
      - alert: MobileDAUDropping
        expr: |
          (
            count(count by (user_id) (mobile_session_starts_total[1d])) -
            count(count by (user_id) (mobile_session_starts_total[1d] offset 7d))
          ) / count(count by (user_id) (mobile_session_starts_total[1d] offset 7d)) * 100 < -20
        for: 30m
        labels:
          severity: warning
          category: adoption
          kpi: daily_active_users
        annotations:
          summary: 'Mobile DAU dropped significantly'
          description: 'Daily Active Users dropped by more than 20% compared to last week (current: {{ $value | humanizePercentage }})'
          runbook_url: 'https://docs.drouple.com/runbooks/mobile-dau-drop'
          dashboard_url: 'https://grafana.drouple.com/d/drouple_mobile_kpi'

      - alert: MobileMAUTrendDown
        expr: |
          (
            count(count by (user_id) (mobile_session_starts_total[30d])) -
            count(count by (user_id) (mobile_session_starts_total[30d] offset 30d))
          ) / count(count by (user_id) (mobile_session_starts_total[30d] offset 30d)) * 100 < -10
        for: 2h
        labels:
          severity: warning
          category: adoption
          kpi: monthly_active_users
        annotations:
          summary: 'Mobile MAU declining'
          description: 'Monthly Active Users declined by {{ $value | humanizePercentage }} vs previous month'
          runbook_url: 'https://docs.drouple.com/runbooks/mobile-mau-decline'

      - alert: Mobile30DayRetentionLow
        expr: |
          (count(count by (user_id) (mobile_retention_milestone_total{milestone="day_30"})) / count(count by (user_id) (mobile_user_registrations_total{created_at_days_ago="30"}))) * 100 < 50
        for: 1h
        labels:
          severity: critical
          category: adoption
          kpi: retention_30_day
        annotations:
          summary: 'Mobile 30-day retention critically low'
          description: '30-day retention rate is {{ $value | humanizePercentage }}, below critical threshold of 50%'
          runbook_url: 'https://docs.drouple.com/runbooks/mobile-retention-critical'

  - name: mobile.engagement
    rules:
      - alert: MobileCheckinUsageBelowTarget
        expr: |
          ((sum(rate(mobile_checkin_completed_total[7d])) / sum(rate(web_checkin_completed_total[7d]))) - 1) * 100 < 20
        for: 1h
        labels:
          severity: warning
          category: engagement
          kpi: checkin_usage_vs_web
        annotations:
          summary: 'Mobile check-in usage below target'
          description: 'Mobile check-ins are only {{ $value | humanizePercentage }} higher than web (target: +40%)'
          runbook_url: 'https://docs.drouple.com/runbooks/mobile-checkin-adoption'

      - alert: MobilePushCTRLow
        expr: |
          (sum(rate(mobile_push_clicked_total[7d])) / sum(rate(mobile_push_delivered_total[7d]))) * 100 < 15
        for: 30m
        labels:
          severity: warning
          category: engagement
          kpi: push_notification_ctr
        annotations:
          summary: 'Push notification CTR below expectations'
          description: 'Push CTR is {{ $value | humanizePercentage }} (target: 25%)'
          runbook_url: 'https://docs.drouple.com/runbooks/push-ctr-optimization'

      - alert: MobileSessionDurationDropped
        expr: |
          histogram_quantile(0.50, rate(mobile_session_duration_seconds_bucket[7d])) / 60 < 3
        for: 45m
        labels:
          severity: info
          category: engagement
          kpi: session_duration
        annotations:
          summary: 'Mobile session duration decreased'
          description: 'Median session duration dropped to {{ $value | printf "%.1f" }} minutes'
          runbook_url: 'https://docs.drouple.com/runbooks/session-duration-analysis'

      - alert: MobileFeaturesUsedPerSessionLow
        expr: |
          avg(mobile_features_used_per_session) < 2
        for: 1h
        labels:
          severity: warning
          category: engagement
          kpi: features_used_percentage
        annotations:
          summary: 'Users engaging with fewer features per session'
          description: 'Average features used per session: {{ $value | printf "%.1f" }} (healthy range: 3-5)'
          runbook_url: 'https://docs.drouple.com/runbooks/feature-engagement'

  - name: mobile.performance
    rules:
      - alert: MobileColdStartSlow
        expr: |
          histogram_quantile(0.95, rate(mobile_app_launch_duration_ms_bucket{launch_type="cold_start"}[5m])) > 2000
        for: 10m
        labels:
          severity: critical
          category: performance
          kpi: cold_start_time
        annotations:
          summary: 'Mobile app cold start time exceeds target'
          description: 'P95 cold start time: {{ $value | printf "%.0f" }}ms (target: <2000ms)'
          runbook_url: 'https://docs.drouple.com/runbooks/app-launch-performance'
          dashboard_url: 'https://grafana.drouple.com/d/drouple_mobile_performance'

      - alert: MobileAPIResponseTimeSlow
        expr: |
          histogram_quantile(0.95, rate(mobile_api_duration_ms_bucket[5m])) > 500
        for: 5m
        labels:
          severity: warning
          category: performance
          kpi: api_response_p95
        annotations:
          summary: 'Mobile API response time degraded'
          description: 'P95 API response time: {{ $value | printf "%.0f" }}ms (target: <500ms)'
          runbook_url: 'https://docs.drouple.com/runbooks/api-performance'

      - alert: MobileCrashRateHigh
        expr: |
          (sum(rate(mobile_crashes_total[5m])) / sum(rate(mobile_sessions_total[5m]))) * 100 > 0.1
        for: 2m
        labels:
          severity: critical
          category: performance
          kpi: crash_rate
        annotations:
          summary: 'Mobile app crash rate exceeded threshold'
          description: 'Crash rate: {{ $value | humanizePercentage }} (target: <0.1%)'
          runbook_url: 'https://docs.drouple.com/runbooks/mobile-crash-analysis'
          action_required: 'Immediate investigation required'

      - alert: MobileOfflineSuccessRateLow
        expr: |
          (sum(rate(mobile_offline_operations_success_total[5m])) / sum(rate(mobile_offline_operations_total[5m]))) * 100 < 95
        for: 10m
        labels:
          severity: warning
          category: performance
          kpi: offline_success_rate
        annotations:
          summary: 'Mobile offline operations failing'
          description: 'Offline success rate: {{ $value | humanizePercentage }} (target: ≥95%)'
          runbook_url: 'https://docs.drouple.com/runbooks/offline-sync-issues'

  - name: mobile.quality
    rules:
      - alert: MobileAppStoreRatingLow
        expr: |
          avg(mobile_app_store_rating) < 4.0
        for: 2h
        labels:
          severity: warning
          category: quality
          kpi: app_store_rating
        annotations:
          summary: 'Mobile app store rating declined'
          description: 'Current rating: {{ $value | printf "%.1f" }}/5.0 (target: ≥4.0)'
          runbook_url: 'https://docs.drouple.com/runbooks/app-store-rating'

      - alert: MobileCSATScoreLow
        expr: |
          avg(mobile_survey_satisfaction_rating) < 3.5
        for: 1h
        labels:
          severity: warning
          category: quality
          kpi: customer_satisfaction
        annotations:
          summary: 'Mobile CSAT score below expectations'
          description: 'CSAT score: {{ $value | printf "%.1f" }}/5.0 (target: ≥4.2)'
          runbook_url: 'https://docs.drouple.com/runbooks/customer-satisfaction'

      - alert: MobileSupportTicketsHigh
        expr: |
          (sum(rate(mobile_support_tickets_total[7d])) / count(count by (user_id) (mobile_sessions_total[7d]))) * 100 > 5
        for: 30m
        labels:
          severity: warning
          category: quality
          kpi: support_tickets
        annotations:
          summary: 'Mobile support ticket volume high'
          description: 'Support tickets: {{ $value | printf "%.1f" }} per 100 users/week (target: <5)'
          runbook_url: 'https://docs.drouple.com/runbooks/support-volume-analysis'

      - alert: MobileBugReportsIncreasing
        expr: |
          increase(mobile_feedback_submitted_total{feedback_type="bug_report"}[7d]) > 25
        for: 1h
        labels:
          severity: info
          category: quality
          kpi: bug_reports
        annotations:
          summary: 'Mobile bug reports increasing'
          description: '{{ $value }} bug reports in past 7 days (threshold: 25)'
          runbook_url: 'https://docs.drouple.com/runbooks/bug-report-triage'

  - name: mobile.business_impact
    rules:
      - alert: MobileCheckinCompletionRateLow
        expr: |
          (sum(rate(mobile_checkin_completed_total[1h])) / sum(rate(mobile_checkin_started_total[1h]))) * 100 < 80
        for: 30m
        labels:
          severity: warning
          category: business_impact
          kpi: checkin_completion_rate
        annotations:
          summary: 'Mobile check-in completion rate low'
          description: 'Check-in completion rate: {{ $value | humanizePercentage }} (healthy: >90%)'
          runbook_url: 'https://docs.drouple.com/runbooks/checkin-completion'

      - alert: MobileEventRSVPRateLow
        expr: |
          (sum(rate(mobile_event_rsvp_total[1h])) / sum(rate(mobile_event_views_total[1h]))) * 100 < 25
        for: 2h
        labels:
          severity: info
          category: business_impact
          kpi: event_rsvp_rate
        annotations:
          summary: 'Mobile event RSVP rate below target'
          description: 'RSVP rate: {{ $value | humanizePercentage }} (target: >40%)'
          runbook_url: 'https://docs.drouple.com/runbooks/event-engagement'

      - alert: MobilePathwayCompletionRateLow
        expr: |
          (sum(rate(mobile_pathway_completed_total[30d])) / sum(rate(mobile_pathway_enrolled_total[30d]))) * 100 < 50
        for: 4h
        labels:
          severity: warning
          category: business_impact
          kpi: pathway_completion_rate
        annotations:
          summary: 'Mobile pathway completion rate declining'
          description: 'Pathway completion rate: {{ $value | humanizePercentage }} (target: >70%)'
          runbook_url: 'https://docs.drouple.com/runbooks/pathway-completion'

  - name: mobile.feature_regressions
    rules:
      - alert: MobileFeatureUsageDropped
        expr: |
          (
            sum by (feature_name) (rate(mobile_feature_usage_total[1d])) -
            sum by (feature_name) (rate(mobile_feature_usage_total[1d] offset 7d))
          ) / sum by (feature_name) (rate(mobile_feature_usage_total[1d] offset 7d)) * 100 < -30
        for: 2h
        labels:
          severity: warning
          category: feature_regression
        annotations:
          summary: 'Mobile feature usage dropped significantly'
          description: '{{ $labels.feature_name }} usage dropped {{ $value | humanizePercentage }} vs last week'
          runbook_url: 'https://docs.drouple.com/runbooks/feature-usage-regression'

      - alert: MobileFeatureErrorRateHigh
        expr: |
          (sum by (feature_name) (rate(mobile_feature_errors_total[5m])) / sum by (feature_name) (rate(mobile_feature_usage_total[5m]))) * 100 > 5
        for: 10m
        labels:
          severity: critical
          category: feature_regression
        annotations:
          summary: 'High error rate in mobile feature'
          description: '{{ $labels.feature_name }} error rate: {{ $value | humanizePercentage }}'
          runbook_url: 'https://docs.drouple.com/runbooks/feature-error-analysis'

      - alert: MobileScreenLoadTimeSlow
        expr: |
          histogram_quantile(0.95, sum by (screen_name) (rate(mobile_screen_load_time_ms_bucket[5m]))) > 3000
        for: 15m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: 'Mobile screen load time degraded'
          description: '{{ $labels.screen_name }} P95 load time: {{ $value | printf "%.0f" }}ms'
          runbook_url: 'https://docs.drouple.com/runbooks/screen-performance'

  - name: mobile.targets_not_met
    rules:
      - alert: MobileKPITargetsMissed
        expr: |
          (
            (count(mobile_checkin_usage_vs_web_percent < 40) > 0) or
            (count(mobile_push_ctr_percent < 25) > 0) or
            (count(mobile_cold_start_p95_ms > 2000) > 0) or
            (count(mobile_api_p95_ms > 500) > 0)
          )
        for: 4h
        labels:
          severity: info
          category: targets
        annotations:
          summary: 'Mobile app not meeting PRD targets'
          description: 'One or more KPI targets are not being met - check dashboard'
          dashboard_url: 'https://grafana.drouple.com/d/drouple_mobile_kpi'
          action_required: 'Review performance and engagement strategies'

# Alert routing and notification configuration
route:
  group_by: ['alertname', 'category']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
    - match:
        category: performance
      receiver: 'engineering-team'
    - match:
        category: business_impact
      receiver: 'product-team'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'

  - name: 'critical-alerts'
    slack_configs:
      - api_url: 'SLACK_WEBHOOK_URL'
        channel: '#mobile-critical-alerts'
        title: 'Critical Mobile Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'

  - name: 'engineering-team'
    slack_configs:
      - api_url: 'SLACK_WEBHOOK_URL'
        channel: '#mobile-engineering'
        title: 'Mobile Engineering Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'

  - name: 'product-team'
    email_configs:
      - to: 'product@drouple.com'
        subject: 'Mobile Business Impact Alert'
        body: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}\n{{ .Annotations.runbook_url }}{{ end }}'
